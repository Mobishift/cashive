
(function(){Crowdhoster.admin={init:function(){var d,h,isSecurityCheckWarningDisplayed,t,_base,_this;isSecurityCheckWarningDisplayed=false;_this=this;$('#settings_custom_css').on("change",function(e){var occ_msg;occ_msg=Crowdhoster.admin.checkSafety('settings_custom_css');return Crowdhoster.admin.checkSafetyAlert(occ_msg,'settings_custom_css','settings_custom_css_alert');});$('#settings_custom_js').on("change",function(e){var occ_msg;occ_msg=Crowdhoster.admin.checkSafety('settings_custom_js');return Crowdhoster.admin.checkSafetyAlert(occ_msg,'settings_custom_js','settings_custom_js_alert');});$('legend.foldable').on('click',function(e){return $(this).parent().find('div.foldable').slideToggle();});$('div.foldable').not('.default_expanded').hide();if(typeof(_base=$('#campaign_expiration_date')).datetimepicker==="function"){_base.datetimepicker({timeFormat:"h:mm tt",minDate:new Date()});}
d=$('#campaign_expiration_date').val();if(d&&d.length>0){d=new Date(d);h=d.getHours();if(h>12){t=(h-12)+':'+("0"+d.getMinutes()).slice(-2)+' pm';}else{if(h===0){h=12;}
t=h+':'+("0"+d.getMinutes()).slice(-2)+' am';}
$('#campaign_expiration_date').val($.datepicker.formatDate('mm/dd/yy',d)+' '+t);}
if($('#campaign_expiration_date').length){$('#campaign_expiration_date')[0].defaultValue=$('#campaign_expiration_date').val();}
$('input#campaign_collect_additional_info').on("change",function(){return $('.additional_info_input').slideToggle();});$('input#campaign_include_comments').on("change",function(){return $('.include_comments_input').slideToggle();});$('input[name="campaign[media_type]"]').on("change",function(){$('#video-options').slideToggle();return $('#image-options').slideToggle();});$('input#campaign_payment_type_any').on("change",function(){$('#preset-amount').slideUp();$('#min-amount').slideUp();$('#no-rewards').slideUp();$('#rewards').slideDown();$('#campaign_collect_shipping_message').hide();$('#campaign_collect_shipping_warning').show();return $('#global-shipping-check').hide();});$('input#campaign_payment_type_fixed').on("change",function(){$('#min-amount').slideUp();$('#preset-amount').slideDown();$('#rewards').slideUp();$('#no-rewards').slideDown();$('#global-shipping').slideDown();$('#global-shipping-check').show();$('#campaign_collect_shipping_message').show();return $('#campaign_collect_shipping_warning').hide();});$('input#campaign_payment_type_min').on("change",function(){$('#preset-amount').slideUp();$('#min-amount').slideDown();$('#no-rewards').slideUp();$('#rewards').slideDown();$('#campaign_collect_shipping_message').hide();$('#campaign_collect_shipping_warning').show();return $('#global-shipping-check').hide();});$('input#goal_type_dollars').on("change",function(){$('input#campaign_payment_type_min').attr('disabled',false);$('input#campaign_payment_type_any').attr('disabled',false);$('#flexible_payment_options').show();$('.amount_input').slideDown();return $('.orders_input').slideUp();});$('input#goal_type_orders').on("change",function(){$('input#campaign_payment_type_fixed').trigger('click');$('input#campaign_payment_type_min').attr('disabled',true);$('input#campaign_payment_type_any').attr('disabled',true);$('#flexible_payment_options').hide();$('.amount_input').slideUp();return $('.orders_input').slideDown();});$('#reward-add').on('click',function(e){var $element,position;e.preventDefault();$element=$('#rewards li:last-child').clone();position=parseInt($('#rewards li').length,10);$element.find('input[name*="price"]').val('0').attr('name',"reward["+position+"][price]");$element.find('input[name*="title"]').val('').attr('name',"reward["+position+"][title]");$element.find('input[name*="image_url"]').val('').attr('name',"reward["+position+"][image_url]");$element.find('textarea[name*="description"]').val('').attr('name',"reward["+position+"][description]");$element.find('input[name*="delivery_date"]').val('').attr('name',"reward["+position+"][delivery_date]");$element.find('input[name*="number"]').val('').attr('name',"reward["+position+"][number]");$element.find('input[name*="collect_shipping_flag"]').attr('name',"reward["+position+"][collect_shipping_flag]");$element.find('input[name*="include_claimed"]').attr('name',"reward["+position+"][include_claimed]");$element.find('input[name*="delete"]').attr('name',"reward["+position+"][delete]");return $element.appendTo('#rewards ul');});$('.faq.sortable').sortable({stop:function(e,ui){var iterator;iterator=1;return $.each($('.faq.sortable li'),function(){var $this;$this=$(this);$this.find('input[name*="sort_order"]').val(iterator).attr('name','faq['+iterator+'][sort_order]');$this.find('textarea[name*="question"]').attr('name','faq['+iterator+'][question]');$this.find('textarea[name*="answer"]').attr('name','faq['+iterator+'][answer]');$this.find('.faq_index').html(iterator);return iterator++;});}});$('#faq-add').on('click',function(e){var $element,position;e.preventDefault();$element=$('.faq.sortable li:last-child').clone();position=parseInt($element.find('.faq_index').html(),10)+1;$element.find('.faq_index').html(position);$element.find('input[name*="sort_order"]').val(position).attr('name','faq['+position+'][sort_order]');$element.find('textarea[name*="question"]').html('').attr('name','faq['+position+'][question]');$element.find('textarea[name*="answer"]').html('').attr('name','faq['+position+'][answer]');return $element.appendTo('.faq.sortable');});$('.faq.sortable').on('click',function(e){var $this,iterator;$this=$(e.target);if($this.is('.faq-delete')){e.preventDefault();$this.parent().remove();iterator=1;return $.each($('.faq.sortable li'),function(){$this=$(this);$this.find('.faq_index').html(iterator);$this.find('input[name="faq[][sort_order]"]').val(iterator);return iterator++;});}});return $('.refund-payment').on('click',function(e){var amount,cell,confirm,email,loader,origColor,paymentId,row,status,total,user_fee_amount;row=$(this).parent().parent();cell=$(this).parent();paymentId=row.find('td.ct_payment_id').text();email=row.find('td.email').text();amount=parseFloat(row.find('td.amount').text().split('$')[1]);user_fee_amount=parseFloat(row.find('td.user_fee_amount').text().split('$')[1]);total=amount+user_fee_amount;confirm=window.confirm("Are you sure you want to refund "+email+" for $"+total.toFixed(2)+"?");if(confirm){loader=row.find('td > .loader');loader.show();status=row.find('td.status');origColor=row.find('td.ct_payment_id').css("background-color");return $.post("/admin/payments/"+paymentId+"/refund").done(function(){status.animate({backgroundColor:'#5cb85c'},400,'swing',function(){return $(this).animate({backgroundColor:origColor});}).text('refunded');return cell.html('');}).fail(function(){status.animate({backgroundColor:'#d9534f'},300,'swing');return setTimeout(function(){return alert('Sorry, this payment could not be refunded. These funds may have already been released to you. If you have any questions, please contact open@crowdtilt.com with the payment ID.');},300);}).always(function(){return loader.hide();});}});},checkSafety:function(editor){var occ_href,occ_msg,occ_orig,reg,regDisp,result,str;reg=new RegExp(/(\s*[:]*?[=]?\s*["]?\s*\b(http)\s*:\s*\/\/[a-zA-Z0-9+&@#\/%?=~_-|!,;:.~-]*)/g);regDisp=new RegExp(/(\b(http)\s*:\s*\/\/[a-zA-Z0-9+&@#\/%?=~_-|!,;:.~-]*)/g);str=$("#"+editor).val();occ_msg="";while((result=reg.exec(str))!==null){occ_orig=str.split(result[1]).length-1;occ_href=str.split("href"+result[1]).length-1;if(occ_orig!==occ_href){occ_msg=occ_msg+"<strong>"+result[1].match(regDisp)+"</strong><br />";}}
return occ_msg;},checkSafetyAlert:function(occ_msg,element,alertElement){if(occ_msg!==''){$('#'+alertElement).html('It looks you are trying to load external content using insecure (non-HTTPS) links. Unless you change the following links to be served over HTTPS, your contributors will see a security warning in their browser.<br />'+occ_msg+'<br />If you need any help with this, please contact open@crowdtilt.com');$('#'+alertElement).slideDown();$('#'+element).addClass('text-area-border');return Crowdhoster.admin.isSecurityCheckWarningDisplayed=false;}else{$('#'+alertElement).slideUp();$('#'+element).removeClass('text-area-border');if(Crowdhoster.admin.checkSafety('settings_custom_css')===''){return $('#settings_custom_alert').hide();}}},submitWebsiteForm:function(form){return form.submit();},submitCampaignForm:function(form){var $date;$date=$('#campaign_expiration_date');$date.val(new Date($date.val()).toUTCString());return form.submit();},submitBankForm:function(form){var $form,userData;$('#errors').html('');$('#bank_routing_number').removeAttr('name');$('#account_number').removeAttr('name');$form=$(form);userData={name:$form.find('#full_legal_name').val(),phone:$form.find('#phone').val(),street_address:$form.find('#street_address').val(),postal_code:$form.find('#zip').val(),dob:$form.find('#birth_year').val()+'-'+$form.find('#birth_month').val()};return $.ajax('/ajax/verify',{type:'POST',data:userData,beforeSend:function(jqXHR,settings){return jqXHR.setRequestHeader('X-CSRF-Token',$('meta[name="csrf-token"]').attr('content'));},success:function(data){if(data==="success"){return Crowdhoster.admin.createBankAccount($form);}else{$('#errors').append('<p>An error occurred, please re-enter your account information</p>');$('.loader').hide();$('#bank_routing_number').attr('name','bank_routing_number');return $('#account_number').attr('name','account_number');}}});},createBankAccount:function($form){var bankData,errors,user_id;bankData={account_number:$form.find('#account_number').val(),name:$form.find('#full_legal_name').val(),bank_code:$form.find('#bank_routing_number').val()};errors={};if(!crowdtilt.bank.validateUSARoutingNumber(bankData.bank_code)){errors["bank_routing_number"]="Invalid routing number";}
if(bankData.account_number===''){errors["bank_account_number"]="Invalid account number";}
if(!$.isEmptyObject(errors)){$.each(errors,function(index,value){return $('#errors').append('<p>'+value+'</p>');});$('.loader').hide();$('#bank_routing_number').attr('name','bank_routing_number');return $('#account_number').attr('name','account_number');}else{user_id=$form.find('#ct_user_id').val();return crowdtilt.bank.create(user_id,bankData,Crowdhoster.admin.bankResponseHandler);}},bankResponseHandler:function(response){var form,input,token;switch(response.status){case 201:token=response.bank.id;input=$('<input name="ct_bank_id" value="'+token+'" type="hidden" />');form=document.getElementById('admin_bank_form');form.appendChild(input[0]);return form.submit();default:$('#errors').append('<p>An error occurred. Please try again.</p>');$('.loader').hide();$('#bank_routing_number').attr('name','bank_routing_number');return $('#account_number').attr('name','account_number');}}};}).call(this);(function(){Crowdhoster.campaigns={init:function(){var _this;_this=this;this.timeCheck('#days');$("#video_image").on("click",function(){$("#player").removeClass("hidden");$("#player").css('display','block');return $(this).hide();});if(($('#checkout').length)){$('html,body').animate({scrollTop:$('#header')[0].scrollHeight});}
$('#quantity').on("change",function(e){var $amount,new_amount,quantity;quantity=$(this).val();$amount=$('#amount');new_amount=parseFloat($amount.attr('data-original'))*quantity;$amount.val(new_amount);return $('#total').html(new_amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","));});$('#amount').on("keyup",function(e){$(this).addClass('edited');$('#amount').removeClass('error');return $('.error').hide();});$('.reward_option.active').on("click",function(e){var $amount,$this;$this=$(this);if(!$(e.target).hasClass('reward_edit')){$amount=$('#amount');$this.find('input').prop('checked',true);$('.reward_option').removeClass('selected').hide();$this.addClass('selected').show();$('.reward_edit').show();$('html,body').animate({scrollTop:$('#checkout').offset().top});if(!$amount.hasClass('edited')){return $amount.val($this.attr('data-price'));}}});$('.reward_edit').on("click",function(e){e.preventDefault();$('.reward_edit').hide();$('.reward_option').removeClass('selected').show();$('input').prop('checked',false);$('#amount').removeClass('error');return $('.error').hide();});return $('#amount_form').on("submit",function(e){var $amount,$reward;e.preventDefault();$reward=$('.reward_option.selected');$amount=$('#amount');if($reward&&$amount.val().length===0){$amount.val($reward.attr('data-price'));return this.submit();}else if($reward&&(parseFloat($reward.attr('data-price'))>parseFloat($amount.val()))){$amount.addClass('error');return $('.error').html('Amount must be at least $'+$reward.attr('data-price')+' to select that '+$('#reward_select').attr('data-reference')+'.').show();}else{return this.submit();}});},submitPaymentForm:function(form){var $form,cardData,errors;$('#refresh-msg').show();$('#errors').hide();$('#errors').html('');$('button[type="submit"]').attr('disabled',true).html('Processing, please wait...');$('#card_number').removeAttr('name');$('#security_code').removeAttr('name');$form=$(form);cardData={number:$form.find('#card_number').val().replace(/\s/g,""),expiration_month:$form.find('#expiration_month').val(),expiration_year:$form.find('#expiration_year').val(),security_code:$form.find('#security_code').val(),postal_code:$form.find('#billing_postal_code').val()};errors=crowdtilt.card.validate(cardData);if(!$.isEmptyObject(errors)){$.each(errors,function(index,value){return $('#errors').append('<p>'+value+'</p>');});return Crowdhoster.campaigns.resetPaymentForm();}else{return $.post($form.attr('data-user-create-action'),{email:$(document.getElementById('email')).val()}).done(function(user_id){$('#ct_user_id').val(user_id);return crowdtilt.card.create(user_id,cardData,Crowdhoster.campaigns.cardResponseHandler);}).fail(function(jqXHR,textStatus){Crowdhoster.campaigns.resetPaymentForm();if(jqXHR.status===400){return $('#errors').append('<p>Sorry, we weren\'t able to process your contribution. Please try again.</p><br><p>If you continue to experience issues, please <a href="mailto:open@crowdtilt.com?subject=Support request for creating user payment">click here</a> to email support.</p>');}else{return $('#errors').append('<p>Sorry, we weren\'t able to process your contribution. Please try again.</p><br><p>If you continue to experience issues, please <a href="mailto:open@crowdtilt.com?subject=Unable to create user payment">click here</a> to email support.</p>');}});}},resetPaymentForm:function(with_errors){var $button;if(with_errors==null){with_errors=true;}
$('#refresh-msg').hide();if(with_errors){$('#errors').show();}
$('.loader').hide();$button=$('button[type="submit"]');$button.attr('disabled',false).html('Confirm payment of $'+$button.attr('data-total'));$('#card_number').attr('name','card_number');return $('#security_code').attr('name','security_code');},timeCheck:function(element){var date_moment,days,expiration,expired,hours,months,refDate,refDiff;expiration=$(element).attr("date-element");date_moment=moment.unix(expiration);expired=moment().diff(date_moment,"seconds")>0;if(expired){$(element).html("No <span>days left!</span>");return;}
months=date_moment.diff(moment(),"months");days=date_moment.diff(moment(),"days");refDate="months";refDiff=months;if(days<120){hours=date_moment.diff(moment(),"hours");if(hours>72){refDiff=days;refDate="days";}else{if(hours>=2){refDiff=hours;refDate="hours";}else{refDiff=date_moment.diff(moment(),"minutes");refDate="minutes";}}}
return $(element).html(refDiff+"<span style=\"width:100px\">"+refDate+" left</span>");},cardResponseHandler:function(response){var $button,card_input,card_token,data,error_path,form,previous_token_elem,request_id_token,request_input;form=document.getElementById('payment_form');request_id_token=response.request_id;previous_token_elem=$("input[name='ct_tokenize_request_id']");if(previous_token_elem.length>0){previous_token_elem.attr('value',request_id_token);}else{request_input=$('<input name="ct_tokenize_request_id" value="'+request_id_token+'" type="hidden" />');form.appendChild(request_input[0]);}
$('#client_timestamp').val((new Date()).getTime());switch(response.status){case 201:card_token=response.card.id;card_input=$('<input name="ct_card_id" value="'+card_token+'" type="hidden" />');form.appendChild(card_input[0]);return form.submit();default:$('#refresh-msg').hide();$('#errors').append('<p>An error occurred. Please check your credit card details and try again.</p><br><p>If you continue to experience issues, please <a href="mailto:open@crowdtilt.com?subject=Support request for a payment issue&body=PLEASE DESCRIBE YOUR PAYMENT ISSUES HERE">click here</a> to contact support.</p>');$('#errors').show();$('.loader').hide();$button=$('button[type="submit"]');$button.attr('disabled',false).html('Confirm payment of $'+$button.attr('data-total'));data=$(form).serializeObject();data.ct_tokenize_request_error_id=response.error_id;delete data.card_number;delete data.security_code;error_path=form.getAttribute('data-error-action');return $.post(error_path,data);}}};}).call(this);(function(){window.Crowdhoster={init:function(){$('.show_loader').on("click",function(){var $this,target;$this=$(this);target=$this.attr('data-loader');return $('.loader').filter('[data-loader="'+target+'"]').show();});$('.show_tooltip').tooltip();return $.fn.serializeObject=function(){var arrayData,objectData;arrayData=this.serializeArray();objectData={};$.each(arrayData,function(){var value;if(this.value!=null){value=this.value;}else{value='';}
if(objectData[this.name]!=null){if(!objectData[this.name].push){objectData[this.name]=[objectData[this.name]];}
return objectData[this.name].push(value);}else{return objectData[this.name]=value;}});return objectData;};}};$(function(){Crowdhoster.init();Crowdhoster.admin.init();return Crowdhoster.campaigns.init();});}).call(this);